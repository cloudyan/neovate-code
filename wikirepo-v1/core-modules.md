# 核心模块详解

## 1. Context 上下文管理

### 概述

Context 模块是整个应用的核心，作为依赖注入容器，管理所有核心依赖。它实现了依赖注入容器模式、工厂模式和单例模式。

### 主要职责

1. **依赖注入容器**: 管理所有核心依赖（配置、插件、路径、MCP 等）
2. **配置集中管理**: 合并多个来源的配置（文件、命令行、插件）
3. **插件生命周期管理**: 协调插件的加载、初始化和销毁
4. **路径访问接口**: 提供统一的路径访问接口

### 创建流程

1. 初始化路径管理器
2. 创建配置管理器，加载和合并配置
3. 扫描插件（内置 → 全局 → 项目 → 配置文件 → 命令行）
4. 规范化插件（字符串路径 → Plugin 对象）
5. 创建 PluginManager
6. 触发 config 钩子，允许插件修改配置
7. 合并 MCP 配置，创建 MCPManager
8. 创建并返回 Context 实例

### 关键方法

- `Context.create()`: 静态方法，创建Context实例
- `context.apply()`: 触发插件钩子
- `context.destroy()`: 销毁上下文，清理资源

## 2. Project 项目核心

### 概述

Project 类是业务逻辑的核心，主要负责会话管理、消息处理和AI交互循环。

### 主要职责

1. **会话管理**: 负责会话创建、恢复和历史管理
2. **消息处理**: 处理用户消息、生成系统提示词
3. **AI交互循环**: 执行核心的AI交互循环
4. **工具审批**: 实现完整的工具调用审批机制

### 核心功能

#### 普通模式

允许读写操作，支持完整的工具集。

#### 规划模式

仅允许只读操作，用于生成计划。

#### 工具审批逻辑

完善的审批机制，包括:
- YOLO模式：全部自动批准
- 只读工具：自动批准
- 工具自定义审批逻辑
- autoEdit模式：写入工具自动批准
- 会话级审批白名单
- 用户审批请求

### 关键方法

- `project.send()`: 发送消息
- `project.plan()`: 规划模式
- `project.sendWithSystemPromptAndTools()`: 核心发送逻辑

## 3. 工具系统

### 概述

Neovate 实现了一个强大的工具系统，包含读取、写入、执行命令等多种工具。

### 工具分类

#### 只读工具

- `read`: 读取文件内容
- `ls`: 列出目录内容
- `glob`: 文件模式匹配
- `grep`: 搜索文件内容
- `fetch`: 获取URL内容

#### 写入工具

- `write`: 写入文件
- `edit`: 编辑文件
- `bash`: 执行shell命令

#### 待办工具

- `todo read`: 读取待办事项
- `todo write`: 写入待办事项

#### MCP工具

通过Model Context Protocol扩展的工具。

### 工具实现

#### Read 工具

支持文本文件和图像文件，具有安全检查防止路径遍历攻击。

#### Edit 工具

使用精确的文本替换机制，要求先使用read工具后再编辑。

#### Write 工具

自动创建目录，确保文件以换行符结尾。

#### Bash 工具

安全检查：禁止危险命令，包含禁用命令列表。

#### Glob 工具

使用glob库进行文件模式匹配，结果按修改时间排序。

#### Grep 工具

使用ripgrep进行快速搜索，支持文件模式过滤。

### 工具管理

- `resolveTools()`: 解析可用工具
- `Tools` 类: 管理工具集合
- `createTool()`: 创建新工具

## 4. 会话管理

### 概述

会话管理实现持久化和恢复功能，确保对话连续性。

### 主要职责

1. 会话创建和恢复
2. 消息历史管理
3. 会话数据持久化

### 关键组件

- `Session` 类: 会话管理
- `SessionConfigManager` 类: 会话配置管理
- `loadSessionMessages()`: 加载会话消息

## 5. MCP (Model Context Protocol) 集成

### 概述

MCP 集成允许Neovate连接到外部AI服务和工具。

### 主要职责

1. MCP服务器管理
2. 工具集成
3. 外部服务连接

### 关键组件

- `MCPManager` 类: MCP服务器管理器
- `parseMcpConfig()`: 解析MCP配置

## 6. UI 组件

### 概述

基于React和Ink的终端UI组件，提供了丰富的交互体验。

### 主要组件

1. **聊天组件**: 显示对话内容
2. **输入组件**: 处理用户输入
3. **工具显示组件**: 显示工具执行结果
4. **文件操作组件**: 文件浏览和操作
5. **代码渲染组件**: 代码高亮显示

### 架构

- **终端UI**: 基于Ink的React组件
- **浏览器UI**: 基于React的Web组件
- **UI桥接**: UIBridge和NodeBridge分离关注点

## 7. 命令系统

### 概述

包含各种命令行命令（config, commit, mcp, run, update等）。

### 主要命令

- `config`: 配置管理
- `commit`: Git提交
- `mcp`: MCP服务器管理
- `run`: 运行自定义命令
- `update`: 检查和应用更新

## 8. 斜杠命令

### 概述

内置命令系统，可以通过斜杠前缀访问。

### 主要命令

- `/clear`: 清除屏幕
- `/compact`: 紧凑模式
- `/exit`: 退出
- `/help`: 帮助信息
- `/init`: 初始化
- `/model`: 模型选择
- `/login`: 登录
- `/logout`: 登出
