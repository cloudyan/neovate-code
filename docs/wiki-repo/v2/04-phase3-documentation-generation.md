# é˜¶æ®µ3: ç»“æ„åŒ–æ–‡æ¡£ç”Ÿæˆ

> **æ—¶é•¿**: 40-50åˆ†é’Ÿ
> **ç›®æ ‡**: åŸºäºå‰ä¸¤é˜¶æ®µåˆ†æ,ç”Ÿæˆé«˜è´¨é‡ã€ç»“æ„åŒ–çš„æ–‡æ¡£åº“
> **è¾“å…¥**: é˜¶æ®µ1çš„åˆ†ææŠ¥å‘Š + é˜¶æ®µ2çš„æ·±åº¦åˆ†æ
> **è¾“å‡º**: å®Œæ•´çš„ Wiki æ–‡æ¡£åº“ (25+ ä¸ªæ–‡æ¡£æ–‡ä»¶)

---

## ğŸ¯ ç›®æ ‡

å°†å‰ä¸¤ä¸ªé˜¶æ®µçš„åˆ†ææˆæœè½¬åŒ–ä¸ºç»“æ„åŒ–ã€æ˜“è¯»ã€æœ‰ä»·å€¼çš„æ–‡æ¡£åº“,ç¡®ä¿:
- âœ… æ ¸å¿ƒæ¶æ„æ¸…æ™°å‘ˆç°
- âœ… å…³é”®æ¨¡å—æ·±åº¦è§£æ
- âœ… é‡è¦æµç¨‹é…æœ‰å›¾ç¤º
- âœ… æ‰€æœ‰ç»“è®ºæœ‰ä»£ç å®è¯
- âœ… æ–‡æ¡£é€»è¾‘æ­£ç¡®å®Œæ•´

---

## ğŸ“ æ–‡æ¡£ä½“ç³»è®¾è®¡

### æ ‡å‡†æ–‡æ¡£ç»“æ„

```
wikirepo/
â”œâ”€â”€ README.md                       # æ–‡æ¡£å¯¼èˆªé¦–é¡µ
â”œâ”€â”€ index.md                        # é¡¹ç›®æ€»è§ˆ
â”œâ”€â”€ quick-start/                    # å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ installation.md             # å®‰è£…æŒ‡å—
â”‚   â”œâ”€â”€ basic-usage.md              # åŸºç¡€ä½¿ç”¨
â”‚   â””â”€â”€ first-example.md            # ç¬¬ä¸€ä¸ªç¤ºä¾‹
â”œâ”€â”€ architecture/                   # æ¶æ„æ–‡æ¡£
â”‚   â”œâ”€â”€ overview.md                 # æ¶æ„æ€»è§ˆ â­
â”‚   â”œâ”€â”€ design-principles.md        # è®¾è®¡åŸåˆ™
â”‚   â”œâ”€â”€ layered-structure.md        # åˆ†å±‚ç»“æ„
â”‚   â”œâ”€â”€ data-flow.md                # æ•°æ®æµè½¬ â­
â”‚   â””â”€â”€ patterns.md                 # è®¾è®¡æ¨¡å¼
â”œâ”€â”€ core-modules/                   # æ ¸å¿ƒæ¨¡å— (æŒ‰ä¼˜å…ˆçº§æ’åº)
â”‚   â”œâ”€â”€ 01-loop.md                  # AIå¾ªç¯ â­â­â­â­â­
â”‚   â”œâ”€â”€ 02-context.md               # ä¸Šä¸‹æ–‡ â­â­â­â­
â”‚   â”œâ”€â”€ 03-project.md               # é¡¹ç›®ç®¡ç† â­â­â­â­
â”‚   â””â”€â”€ ...                         # å…¶ä»–æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ subsystems/                     # å­ç³»ç»Ÿ
â”‚   â”œâ”€â”€ tool-system.md              # å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ plugin-system.md            # æ’ä»¶ç³»ç»Ÿ
â”‚   â””â”€â”€ session-management.md       # ä¼šè¯ç®¡ç†
â”œâ”€â”€ workflows/                      # æµç¨‹æ–‡æ¡£
â”‚   â”œâ”€â”€ user-interaction.md         # ç”¨æˆ·äº¤äº’æµç¨‹
â”‚   â”œâ”€â”€ tool-approval.md            # å·¥å…·å®¡æ‰¹æµç¨‹
â”‚   â””â”€â”€ ai-loop.md                  # AIå¾ªç¯æµç¨‹
â”œâ”€â”€ api-reference/                  # API å‚è€ƒ
â”‚   â”œâ”€â”€ classes/                    # ç±»æ–‡æ¡£
â”‚   â”œâ”€â”€ functions/                  # å‡½æ•°æ–‡æ¡£
â”‚   â””â”€â”€ types/                      # ç±»å‹æ–‡æ¡£
â”œâ”€â”€ guides/                         # æŒ‡å—
â”‚   â”œâ”€â”€ development.md              # å¼€å‘æŒ‡å—
â”‚   â”œâ”€â”€ testing.md                  # æµ‹è¯•æŒ‡å—
â”‚   â”œâ”€â”€ debugging.md                # è°ƒè¯•æŒ‡å—
â”‚   â””â”€â”€ best-practices.md           # æœ€ä½³å®è·µ
â”œâ”€â”€ faq.md                          # å¸¸è§é—®é¢˜
â””â”€â”€ glossary.md                     # æœ¯è¯­è¡¨
```

### æ–‡æ¡£ç”Ÿæˆé¡ºåº

æŒ‰ä¼˜å…ˆçº§é¡ºåºç”Ÿæˆæ–‡æ¡£:

1. **ç¬¬1ä¼˜å…ˆçº§**: æ¶æ„æ–‡æ¡£ + æ ¸å¿ƒæ¨¡å—æ–‡æ¡£
2. **ç¬¬2ä¼˜å…ˆçº§**: æµç¨‹æ–‡æ¡£ + API å‚è€ƒ
3. **ç¬¬3ä¼˜å…ˆçº§**: æŒ‡å— + å­ç³»ç»Ÿæ–‡æ¡£
4. **ç¬¬4ä¼˜å…ˆçº§**: å¿«é€Ÿå¼€å§‹ + è¾…åŠ©æ–‡æ¡£

---

## ğŸ“ æ ¸å¿ƒæ–‡æ¡£æ¨¡æ¿

### æ¨¡æ¿1: æ¶æ„æ–‡æ¡£ (`architecture/overview.md`)

```markdown
# æ¶æ„æ€»è§ˆ

> æœ¬æ–‡æ¡£åŸºäºä»£ç åˆ†æè‡ªåŠ¨ç”Ÿæˆ,è¦†ç›– 15 ä¸ªæ ¸å¿ƒæ¨¡å—
> åˆ†ææ—¶é—´: 2025-10-24
> æ–‡æ¡£ç‰ˆæœ¬: v1.0

## ä¸€ã€æ¶æ„å±‚æ¬¡

```mermaid
graph TD
    A[Presentation Layer] --> B[Business Layer]
    B --> C[Data Layer]
    C --> D[Database & External Services]

    A -.-> E[DTO Validation]
    B -.-> F[Business Logic]
    C -.-> G[Data Access]

    style A fill:#ff6b6b,color:#fff
    style B fill:#4ecdc4,color:#fff
    style C fill:#45b7d1,color:#fff
```

### å„å±‚èŒè´£

| å±‚çº§ | èŒè´£ | æ ¸å¿ƒæ¨¡å— | æŠ€æœ¯å®ç° |
|------|------|----------|----------|
| è¡¨ç°å±‚ | HTTPè¯·æ±‚å¤„ç†,å‚æ•°éªŒè¯,å“åº”æ ¼å¼åŒ– | `controllers/` | Express Router, DTOéªŒè¯ |
| ä¸šåŠ¡å±‚ | ä¸šåŠ¡é€»è¾‘,é¢†åŸŸæ¨¡å‹,äº‹åŠ¡ç®¡ç† | `services/` | é¢†åŸŸæœåŠ¡,äº‹åŠ¡è„šæœ¬ |
| æ•°æ®å±‚ | æ•°æ®è®¿é—®,æŒä¹…åŒ–,ç¼“å­˜ | `repositories/` | ORM, æ•°æ®æ˜ å°„å™¨ |

## äºŒã€æ ¸å¿ƒç»„ä»¶

```mermaid
graph LR
    A[Loop Engine] --> B[Context Manager]
    A --> C[Project Manager]
    B --> D[Tool System]
    C --> D
    D --> E[Plugin System]

    style A fill:#ff6b6b,color:#fff
    style B fill:#4ecdc4,color:#fff
```

### ç»„ä»¶è¯´æ˜

#### 1. Loop Engine (`src/loop.ts:1-450`)
**èŒè´£**: AIä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œç®¡ç†
**å…³é”®è®¾è®¡**: è§‚å¯Ÿè€…æ¨¡å¼ + ç­–ç•¥æ¨¡å¼
**ä¾èµ–å…³ç³»**: Context, Project, Tools
**æ€§èƒ½è€ƒè™‘**: å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—, è¶…æ—¶æ§åˆ¶

#### 2. Context Manager (`src/context.ts:1-280`)
**èŒè´£**: ä¼šè¯çŠ¶æ€å’Œä¸Šä¸‹æ–‡ç®¡ç†
**å…³é”®è®¾è®¡**: ä¸å¯å˜æ•°æ® + äº‹ä»¶é€šçŸ¥
**ä¾èµ–å…³ç³»**: Types, Utils
**å†…å­˜ç®¡ç†**: WeakMapå­˜å‚¨, è‡ªåŠ¨æ¸…ç†

## ä¸‰ã€æ•°æ®æµ

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Loop
    participant Context
    participant Tools

    User->>Frontend: æäº¤è¯·æ±‚
    Frontend->>Loop: æ‰§è¡Œä»»åŠ¡
    Loop->>Context: è·å–ä¸Šä¸‹æ–‡
    Context-->>Loop: è¿”å›ä¸Šä¸‹æ–‡æ•°æ®
    Loop->>Tools: è°ƒç”¨å·¥å…·
    Tools-->>Loop: è¿”å›ç»“æœ
    Loop->>Loop: å¤„ç†ç»“æœ
    Loop-->>Frontend: è¿”å›å“åº”
    Frontend-->>User: æ˜¾ç¤ºç»“æœ
```

### å…³é”®æµç¨‹è¯´æ˜

#### é˜¶æ®µ1: è¯·æ±‚å¤„ç†
**ä»£ç ä½ç½®**: `src/loop.ts:150-180`
```typescript
// éªŒè¯ä»»åŠ¡å‚æ•°
function validateTask(task: Task): boolean {
  if (!task.type || !task.input) {
    throw new Error('Invalid task format');
  }
  return true;
}
```

#### é˜¶æ®µ2: ä¸Šä¸‹æ–‡å‡†å¤‡
**ä»£ç ä½ç½®**: `src/loop.ts:181-210`
```typescript
// å‡†å¤‡æ‰§è¡Œä¸Šä¸‹æ–‡
function prepareContext(context: Context, task: Task): ExecutionContext {
  return {
    ...context,
    taskId: task.id,
    timestamp: Date.now()
  };
}
```

## å››ã€è®¾è®¡ç‰¹ç‚¹

- âœ… **æ¨¡å—åŒ–è®¾è®¡** - åŠŸèƒ½æ¨¡å—æ¸…æ™°åˆ†ç¦»
- âœ… **æ¥å£é©±åŠ¨** - å®šä¹‰æ¸…æ™°çš„æ¨¡å—æ¥å£
- âœ… **é”™è¯¯å¤„ç†** - å®Œæ•´çš„é”™è¯¯å¤„ç†é“¾æ¡
- âœ… **æ€§èƒ½ä¼˜åŒ–** - å…³é”®è·¯å¾„æ€§èƒ½ç›‘æ§
- âœ… **å¯æ‰©å±•æ€§** - æ”¯æŒæ’ä»¶å’Œæ‰©å±•

## äº”ã€æ‰©å±•æœºåˆ¶

### æ’ä»¶ç³»ç»Ÿ
é¡¹ç›®æ”¯æŒæ’ä»¶æ‰©å±•:

```typescript
// æ³¨å†Œè‡ªå®šä¹‰å·¥å…·
ToolSystem.registerTool('custom-tool', {
  execute: async (input, context) => {
    // è‡ªå®šä¹‰å·¥å…·é€»è¾‘
    return { success: true, output: processedData };
  }
});
```

### é…ç½®ç³»ç»Ÿ
æ”¯æŒè¿è¡Œæ—¶é…ç½®:
```typescript
// é…ç½®ç¤ºä¾‹
const config = {
  maxConcurrentTasks: 5,
  defaultTimeout: 30000,
  enableLogging: true
};
```

## å…­ã€ç›¸å…³æ–‡æ¡£

- [Loop æ¨¡å—è¯¦è§£](../core-modules/01-loop.md)
- [Context æ¨¡å—è¯¦è§£](../core-modules/02-context.md)
- [æ•°æ®æµè½¬è¯¦æƒ…](../architecture/data-flow.md)
- [è®¾è®¡æ¨¡å¼æ€»ç»“](../architecture/patterns.md)
```

### æ¨¡æ¿2: æ ¸å¿ƒæ¨¡å—æ–‡æ¡£ (`core-modules/01-loop.md`)

```markdown
# Loop æ¨¡å—è¯¦è§£

> æºç ä½ç½®: [`src/loop.ts`](../src/loop.ts)
> ä¼˜å…ˆçº§: â­â­â­â­â­ (æ ¸å¿ƒæ¨¡å—)
> å¤æ‚åº¦: é«˜ (450LOC, è¢«15ä¸ªæ¨¡å—å¼•ç”¨)

## ç›®å½•
- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒèŒè´£](#æ ¸å¿ƒèŒè´£)
- [è®¾è®¡åŸç†](#è®¾è®¡åŸç†)
- [å…³é”®æµç¨‹](#å…³é”®æµç¨‹)
- [ä»£ç è§£æ](#ä»£ç è§£æ)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

### å®šä½
Loop æ¨¡å—æ˜¯ç³»ç»Ÿçš„AIä»»åŠ¡è°ƒåº¦å¼•æ“,è´Ÿè´£ç®¡ç†AIä»»åŠ¡çš„æ‰§è¡Œç”Ÿå‘½å‘¨æœŸã€‚

### åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®

```mermaid
graph TD
    A[User Input] --> B[Loop Engine]
    B --> C[Context Manager]
    B --> D[Project Manager]
    B --> E[Tool System]
    C --> F[State Management]
    D --> G[Project Data]
    E --> H[Tool Execution]

    style B fill:#ff6b6b,color:#fff
```

### å…³é”®æŒ‡æ ‡
- **ä»£ç è¡Œæ•°**: 450 LOC
- **å¯¼å‡ºå‡½æ•°**: 5 ä¸ª
- **ä¾èµ–æ¨¡å—**: 8 ä¸ª
- **è¢«ä¾èµ–æ¬¡æ•°**: 15 æ¬¡
- **æµ‹è¯•è¦†ç›–ç‡**: 85%

---

## æ ¸å¿ƒèŒè´£

1. **ä»»åŠ¡è°ƒåº¦** - ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—å’Œæ‰§è¡Œä¼˜å…ˆçº§
2. **çŠ¶æ€ç®¡ç†** - ç»´æŠ¤ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€å’Œä¸Šä¸‹æ–‡
3. **é”™è¯¯å¤„ç†** - æ•è·å’Œå¤„ç†æ‰§è¡Œå¼‚å¸¸
4. **æ€§èƒ½ç›‘æ§** - è·Ÿè¸ªä»»åŠ¡æ‰§è¡Œæ€§èƒ½æŒ‡æ ‡
5. **èµ„æºç®¡ç†** - ç®¡ç†æ‰§è¡Œè¿‡ç¨‹ä¸­çš„èµ„æºåˆ†é…

---

## è®¾è®¡åŸç†

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ¨¡å—?
éœ€è¦ç»Ÿä¸€çš„å…¥å£æ¥ç®¡ç†å¤æ‚çš„AIä»»åŠ¡æ‰§è¡Œæµç¨‹,ç¡®ä¿:
- ä»»åŠ¡æ‰§è¡Œçš„å¯é æ€§å’Œç¨³å®šæ€§
- èµ„æºä½¿ç”¨çš„åˆç†æ€§å’Œæ•ˆç‡
- é”™è¯¯å¤„ç†çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- æ€§èƒ½ç›‘æ§çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§

### è®¾è®¡ç›®æ ‡
- âœ… **å¯é æ€§** - 99.9%çš„ä»»åŠ¡æ‰§è¡ŒæˆåŠŸç‡
- âœ… **æ€§èƒ½** - å¹³å‡å“åº”æ—¶é—´ < 2ç§’
- âœ… **å¯æ‰©å±•** - æ”¯æŒæ–°çš„ä»»åŠ¡ç±»å‹å’Œå·¥å…·
- âœ… **å¯ç»´æŠ¤** - æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£

### ä½¿ç”¨çš„è®¾è®¡æ¨¡å¼

#### 1. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)
**åº”ç”¨**: ä»»åŠ¡çŠ¶æ€å˜æ›´é€šçŸ¥
**ä»£ç ä½ç½®**: `src/loop.ts:320-350`
**ä¼˜åŠ¿**: è§£è€¦çŠ¶æ€ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…

#### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
**åº”ç”¨**: ä¸åŒçš„ä»»åŠ¡æ‰§è¡Œç­–ç•¥
**ä»£ç ä½ç½®**: `src/loop.ts:280-310`
**ä¼˜åŠ¿**: æ˜“äºæ‰©å±•æ–°çš„æ‰§è¡Œç­–ç•¥

#### 3. å·¥å‚æ¨¡å¼ (Factory Pattern)
**åº”ç”¨**: åˆ›å»ºä»»åŠ¡å¤„ç†å™¨å®ä¾‹
**ä»£ç ä½ç½®**: `src/loop.ts:230-260`
**ä¼˜åŠ¿**: å°è£…å¤æ‚çš„å¯¹è±¡åˆ›å»ºé€»è¾‘

---

## å…³é”®æµç¨‹

### ä¸»æµç¨‹å›¾

```mermaid
flowchart TD
    A[æ¥æ”¶ä»»åŠ¡] --> B[å‚æ•°éªŒè¯]
    B --> C{éªŒè¯é€šè¿‡?}
    C -->|æ˜¯| D[å‡†å¤‡ä¸Šä¸‹æ–‡]
    C -->|å¦| E[è¿”å›é”™è¯¯]
    D --> F[æ‰§è¡Œä»»åŠ¡é€»è¾‘]
    F --> G[å¤„ç†æ‰§è¡Œç»“æœ]
    G --> H[è¿”å›æˆåŠŸå“åº”]

    style A fill:#ff6b6b,color:#fff
    style H fill:#96ceb4,color:#fff
```

### æµç¨‹è¯´æ˜

#### é˜¶æ®µ1: ä»»åŠ¡éªŒè¯
**ä»£ç ä½ç½®**: `src/loop.ts:150-170`
```typescript
function validateTask(task: Task): boolean {
  if (!task.type) {
    throw new Error('Task type is required');
  }
  if (!task.input) {
    throw new Error('Task input is required');
  }
  return true;
}
```

#### é˜¶æ®µ2: ä¸Šä¸‹æ–‡å‡†å¤‡
**ä»£ç ä½ç½®**: `src/loop.ts:171-200`
```typescript
function prepareContext(context: Context, task: Task): ExecutionContext {
  return {
    ...context,
    taskId: task.id,
    timestamp: Date.now(),
    executionId: generateId()
  };
}
```

#### é˜¶æ®µ3: ä»»åŠ¡æ‰§è¡Œ
**ä»£ç ä½ç½®**: `src/loop.ts:201-230`
```typescript
async function runTaskLogic(task: Task, context: ExecutionContext): Promise<Result> {
  const processor = TaskProcessorFactory.create(task.type);
  return await processor.execute(task.input, context);
}
```

---

## ä»£ç è§£æ

### æ ¸å¿ƒç±»/å‡½æ•°

#### 1. `executeTask()`
**ç­¾å**:
```typescript
async function executeTask(task: Task, context: Context): Promise<Result>
```

**èŒè´£**: æ‰§è¡Œå•ä¸ªAIä»»åŠ¡çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å®ç°è¦ç‚¹**:
1. å®Œæ•´çš„é”™è¯¯å¤„ç†é“¾æ¡
2. ä¸Šä¸‹æ–‡éš”ç¦»å’Œå®‰å…¨ç®¡ç†
3. æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—è®°å½•
4. èµ„æºæ¸…ç†å’Œé‡Šæ”¾

**æºç ä½ç½®**: `src/loop.ts:150-200`

#### 2. `validateTask()`
**ç­¾å**:
```typescript
function validateTask(task: Task): boolean
```

**èŒè´£**: éªŒè¯ä»»åŠ¡å‚æ•°çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§

**éªŒè¯è§„åˆ™**:
- ä»»åŠ¡ç±»å‹å¿…é¡»å­˜åœ¨
- è¾“å…¥å†…å®¹ä¸èƒ½ä¸ºç©º
- å¯é€‰å‚æ•°æ ¼å¼éªŒè¯
- æƒé™å’Œè®¿é—®æ§åˆ¶æ£€æŸ¥

**æºç ä½ç½®**: `src/loop.ts:120-140`

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```typescript
import { executeTask } from './loop';
import { createTask } from './types';

// åˆ›å»ºåˆ†æä»»åŠ¡
const task = createTask({
  type: 'code-analysis',
  input: 'éœ€è¦åˆ†æçš„ä»£ç å†…å®¹',
  options: {
    depth: 'deep',
    language: 'typescript'
  }
});

// æ‰§è¡Œä»»åŠ¡
const result = await executeTask(task, currentContext);

console.log('ä»»åŠ¡ç»“æœ:', result);
```

### é«˜çº§ç”¨æ³•

```typescript
// è‡ªå®šä¹‰ä»»åŠ¡å¤„ç†å™¨
import { TaskProcessor } from './types';

class CustomTaskProcessor implements TaskProcessor {
  async execute(input: any, context: ExecutionContext): Promise<Result> {
    // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
    const processed = await this.processInput(input);
    return {
      success: true,
      data: processed,
      metrics: {
        processingTime: Date.now() - context.timestamp,
        inputSize: input.length
      }
    };
  }

  private async processInput(input: string): Promise<any> {
    // å¤æ‚çš„å¤„ç†é€»è¾‘
    return input.toUpperCase();
  }
}

// æ³¨å†Œè‡ªå®šä¹‰å¤„ç†å™¨
TaskProcessorFactory.register('custom-type', CustomTaskProcessor);
```

---

## å¸¸è§é—®é¢˜

### Q1: ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ€ä¹ˆåŠ?
A: ç³»ç»Ÿå†…ç½®30ç§’è¶…æ—¶æœºåˆ¶,è¶…æ—¶åè‡ªåŠ¨å–æ¶ˆä»»åŠ¡å¹¶è¿”å›è¶…æ—¶é”™è¯¯ã€‚å¯é€šè¿‡é…ç½®è°ƒæ•´è¶…æ—¶æ—¶é—´ã€‚

### Q2: å¦‚ä½•ç›‘æ§ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€?
A: ä½¿ç”¨ `Loop.getTaskStatus(taskId)` æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€,æˆ–ç›‘å¬ä»»åŠ¡çŠ¶æ€å˜æ›´äº‹ä»¶ã€‚

### Q3: æ”¯æŒå¹¶å‘æ‰§è¡Œå—?
A: æ”¯æŒæœ‰é™å¹¶å‘,é»˜è®¤æœ€å¤§å¹¶å‘æ•°ä¸º5ã€‚å¯é€šè¿‡é…ç½®è°ƒæ•´å¹¶å‘æ•°,ä½†éœ€è€ƒè™‘ç³»ç»Ÿèµ„æºé™åˆ¶ã€‚

### Q4: å¦‚ä½•å¤„ç†ä»»åŠ¡å¤±è´¥?
A: ç³»ç»Ÿæä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶,åŒ…æ‹¬é”™è¯¯æ•è·ã€æ—¥å¿—è®°å½•ã€é‡è¯•æœºåˆ¶å’Œé”™è¯¯æ¢å¤ã€‚

---

## ç›¸å…³æ–‡æ¡£

- [æ¶æ„æ€»è§ˆ](../architecture/overview.md)
- [Context æ¨¡å—è¯¦è§£](./02-context.md)
- [ä»»åŠ¡æ‰§è¡Œæµç¨‹](../workflows/task-execution.md)
- [API å‚è€ƒ](../api-reference/classes/Loop.md)
```

### æ¨¡æ¿3: æµç¨‹æ–‡æ¡£ (`workflows/tool-approval.md`)

```markdown
# å·¥å…·å®¡æ‰¹æµç¨‹è¯¦è§£

> æ¶‰åŠæ¨¡å—: `project.ts`, `tool.ts`
> æµç¨‹ç±»å‹: å®¡æ‰¹æµç¨‹
> è§¦å‘åœºæ™¯: AIå°è¯•è°ƒç”¨å·¥å…·æ—¶

## ä¸€ã€æµç¨‹æ¦‚è§ˆ

```mermaid
sequenceDiagram
    participant AI
    participant Loop
    participant Project
    participant Tool
    participant User

    AI->>Loop: è¯·æ±‚è°ƒç”¨å·¥å…·
    Loop->>Project: æ£€æŸ¥å·¥å…·æƒé™
    Project->>Project: éªŒè¯è®¿é—®æƒé™

    alt æœ‰æƒé™
        Project-->>Loop: æ‰¹å‡†è°ƒç”¨
        Loop->>Tool: æ‰§è¡Œå·¥å…·
        Tool-->>Loop: è¿”å›ç»“æœ
        Loop-->>AI: è¿”å›å·¥å…·ç»“æœ
    else éœ€è¦å®¡æ‰¹
        Project->>User: å‘é€å®¡æ‰¹è¯·æ±‚
        User->>Project: å®¡æ‰¹å†³å®š
        Project-->>Loop: å®¡æ‰¹ç»“æœ
        Loop->>Tool: æ‰§è¡Œå·¥å…·ï¼ˆå¦‚æœæ‰¹å‡†ï¼‰
        Tool-->>Loop: è¿”å›ç»“æœ
        Loop-->>AI: è¿”å›æœ€ç»ˆç»“æœ
    end
```

## äºŒã€è§¦å‘æ¡ä»¶

- **æ¡ä»¶1**: AIæ¨¡å‹å°è¯•è°ƒç”¨å—é™åˆ¶çš„å·¥å…·
- **æ¡ä»¶2**: å½“å‰ç”¨æˆ·æƒé™ä¸è¶³
- **æ¡ä»¶3**: å·¥å…·é…ç½®éœ€è¦äººå·¥å®¡æ‰¹

## ä¸‰ã€è¯¦ç»†æ­¥éª¤

### æ­¥éª¤1: æƒé™æ£€æŸ¥
**ä»£ç ä½ç½®**: `src/project.ts:330-340`

**é€»è¾‘**:
```typescript
function checkToolPermission(
  toolName: string,
  context: Context
): PermissionResult {
  const user = context.user;
  const toolConfig = getToolConfig(toolName);

  // æ£€æŸ¥ç”¨æˆ·æƒé™
  if (user.permissions.includes(toolConfig.requiredPermission)) {
    return { allowed: true, reason: 'ç”¨æˆ·æœ‰æƒé™' };
  }

  // æ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æ‰¹
  if (toolConfig.requiresApproval) {
    return {
      allowed: false,
      requiresApproval: true,
      reason: 'éœ€è¦äººå·¥å®¡æ‰¹'
    };
  }

  return { allowed: false, reason: 'æƒé™ä¸è¶³' };
}
```

**åˆ¤æ–­æ¡ä»¶**:
- å¦‚æœç”¨æˆ·æœ‰æƒé™: ç›´æ¥æ‰¹å‡†
- å¦‚æœéœ€è¦å®¡æ‰¹: è§¦å‘å®¡æ‰¹æµç¨‹
- å¦åˆ™: æ‹’ç»è°ƒç”¨

### æ­¥éª¤2: å®¡æ‰¹è¯·æ±‚
**ä»£ç ä½ç½®**: `src/project.ts:350-380`

**é€»è¾‘**:
```typescript
async function requestToolApproval(
  toolName: string,
  context: Context,
  reason: string
): Promise<ApprovalRequest> {
  const request = createApprovalRequest({
    tool: toolName,
    user: context.user.id,
    reason: reason,
    timestamp: Date.now()
  });

  // å‘é€é€šçŸ¥ç»™å®¡æ‰¹äºº
  await notifyApprovers(request);

  return request;
}
```

## å››ã€å†³ç­–æ ‘

```mermaid
flowchart TD
    A[AIè¯·æ±‚è°ƒç”¨å·¥å…·] --> B{ç”¨æˆ·æœ‰æƒé™?}
    B -->|æ˜¯| C[ç›´æ¥æ‰§è¡Œå·¥å…·]
    B -->|å¦| D{éœ€è¦å®¡æ‰¹?}
    D -->|æ˜¯| E[å‘é€å®¡æ‰¹è¯·æ±‚]
    D -->|å¦| F[æ‹’ç»è°ƒç”¨]
    E --> G{ç”¨æˆ·å®¡æ‰¹?}
    G -->|æ‰¹å‡†| C
    G -->|æ‹’ç»| F

    style C fill:#96ceb4,color:#fff
    style F fill:#ff6b6b,color:#fff
```

## äº”ã€ç‰¹æ®Šæƒ…å†µå¤„ç†

### æƒ…å†µ1: å®¡æ‰¹è¶…æ—¶
**å¤„ç†æ–¹å¼**: é»˜è®¤æ‹’ç»,å¯é…ç½®è¶…æ—¶è¡Œä¸º
**é…ç½®é¡¹**: `toolApproval.timeoutBehavior`

### æƒ…å†µ2: å¤šçº§å®¡æ‰¹
**å¤„ç†æ–¹å¼**: æ”¯æŒå¤šçº§å®¡æ‰¹é“¾
**é…ç½®é¡¹**: `toolApproval.approvalChain`

## å…­ã€ç›¸å…³é…ç½®

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `toolApproval.timeout` | 300000 | å®¡æ‰¹è¶…æ—¶æ—¶é—´(5åˆ†é’Ÿ) |
| `toolApproval.timeoutBehavior` | `deny` | è¶…æ—¶é»˜è®¤è¡Œä¸º(deny/allow) |
| `toolApproval.notifyChannels` | `['email']` | é€šçŸ¥æ¸ é“ |

## ä¸ƒã€ç¤ºä¾‹

### ç¤ºä¾‹1: è‡ªåŠ¨é€šè¿‡
```typescript
// ç”¨æˆ·æœ‰æƒé™,ç›´æ¥æ‰§è¡Œ
const result = await executeTool('file-reader', { path: '/etc/hosts' });
```

### ç¤ºä¾‹2: éœ€è¦ç”¨æˆ·å®¡æ‰¹
```typescript
// è§¦å‘å®¡æ‰¹æµç¨‹
const approval = await requestToolApproval(
  'database-writer',
  'éœ€è¦ä¿®æ”¹ç”¨æˆ·æ•°æ®'
);

// ç­‰å¾…å®¡æ‰¹ç»“æœ
const result = await waitForApproval(approval.id);
if (result.approved) {
  await executeTool('database-writer', data);
}
```
```

---

## ğŸ¯ æ–‡æ¡£ç”Ÿæˆè´¨é‡è¦æ±‚

### å®Œæ•´æ€§æ£€æŸ¥
- [ ] æ‰€æœ‰æ ¸å¿ƒæ¨¡å—éƒ½æœ‰ä¸“é—¨æ–‡æ¡£
- [ ] æ‰€æœ‰å…³é”®æµç¨‹éƒ½æœ‰æµç¨‹å›¾
- [ ] æ¶æ„æ–‡æ¡£åŒ…å«å®Œæ•´çš„å±‚æ¬¡è¯´æ˜
- [ ] API æ–‡æ¡£è¦†ç›–æ‰€æœ‰å…¬å¼€æ¥å£

### å‡†ç¡®æ€§æ£€æŸ¥
- [ ] æ‰€æœ‰ä»£ç å¼•ç”¨éƒ½å‡†ç¡® (æ–‡ä»¶åã€è¡Œå·)
- [ ] æµç¨‹å›¾ä¸å®é™…ä»£ç é€»è¾‘ä¸€è‡´
- [ ] æ¶æ„å›¾åæ˜ çœŸå®çš„æ¨¡å—å…³ç³»
- [ ] ç¤ºä¾‹ä»£ç å¯ä»¥å®é™…è¿è¡Œ

### å¯è¯»æ€§æ£€æŸ¥
- [ ] æ–‡æ¡£ç»“æ„æ¸…æ™°,æ ‡é¢˜å±‚æ¬¡åˆ†æ˜
- [ ] æŠ€æœ¯æœ¯è¯­æœ‰è§£é‡Šæˆ–é“¾æ¥åˆ°æœ¯è¯­è¡¨
- [ ] æ¯ä¸ªå¤æ‚æ¦‚å¿µéƒ½æœ‰ç¤ºä¾‹è¯´æ˜
- [ ] å›¾è¡¨æ¸…æ™°æ˜“æ‡‚

### ä»·å€¼æ£€æŸ¥
- [ ] æ–°äººèƒ½é€šè¿‡æ–‡æ¡£å¿«é€Ÿä¸Šæ‰‹
- [ ] ç»éªŒå¼€å‘è€…èƒ½æ·±å…¥ç†è§£æ¶æ„
- [ ] ç»´æŠ¤è€…èƒ½å®šä½åˆ°å…·ä½“ä»£ç ä½ç½®
- [ ] æ–‡æ¡£å†…å®¹ä¸å®é™…ä»£ç åŒæ­¥

---

## ğŸ”§ ç”Ÿæˆå·¥å…·å’ŒæŠ€æœ¯

### æ–‡æ¡£ç”Ÿæˆå·¥å…·

```bash
# ä½¿ç”¨æ¨¡æ¿å¼•æ“ç”Ÿæˆæ–‡æ¡£
npm install handlebars

# ç¤ºä¾‹æ¨¡æ¿ä½¿ç”¨
const template = Handlebars.compile(documentTemplate);
const html = template({
  title: 'æ¶æ„æ€»è§ˆ',
  content: analysisData,
  diagrams: mermaidDiagrams
});
```

### Mermaid å›¾è¡¨é›†æˆ

```markdown
## æ¶æ„å›¾

```mermaid
graph TD
    A[Client] --> B[Server]
    B --> C[Database]
```

## åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant A
    participant B
    A->>B: è¯·æ±‚
    B-->>A: å“åº”
```
```

---

## ğŸ“Š è¾“å‡ºç»Ÿè®¡

### å…¸å‹è¾“å‡ºè§„æ¨¡
- **æ€»æ–‡æ¡£æ•°**: 25-35 ä¸ªæ–‡ä»¶
- **æ€»é¡µæ•°**: 150-200 é¡µ
- **æ€»å¤§å°**: 2-3 MB
- **å›¾è¡¨æ•°é‡**: 20-30 ä¸ª
- **ä»£ç ç¤ºä¾‹**: 50-70 ä¸ª

### è´¨é‡è¯„åˆ†
- **å®Œæ•´æ€§**: 95-100%
- **å‡†ç¡®æ€§**: 90-95%
- **å¯è¯»æ€§**: 85-90%
- **å®ç”¨æ€§**: 90-95%
- **æ€»è¯„åˆ†**: 90-95/100

---

## ğŸ¯ æ€»ç»“

é˜¶æ®µ3å°†å‰ä¸¤ä¸ªé˜¶æ®µçš„åˆ†ææˆæœè½¬åŒ–ä¸ºå®é™…å¯ç”¨çš„æ–‡æ¡£åº“,é€šè¿‡:

1. **ç»“æ„åŒ–ç»„ç»‡** - æ¸…æ™°çš„æ–‡æ¡£ä½“ç³»ç»“æ„
2. **æ¨¡æ¿åŒ–ç”Ÿæˆ** - ç»Ÿä¸€çš„æ–‡æ¡£æ ¼å¼å’Œé£æ ¼
3. **å®è¯åŒ–å†…å®¹** - æ‰€æœ‰ç»“è®ºéƒ½æœ‰ä»£ç å¼•ç”¨
4. **å¯è§†åŒ–è¡¨è¾¾** - å¤æ‚é€»è¾‘é…å›¾è¡¨è¯´æ˜
5. **è´¨é‡åŒ–æ§åˆ¶** - å¤šç»´åº¦çš„è´¨é‡æ£€æŸ¥

ç¡®ä¿ç”Ÿæˆçš„æ–‡æ¡£ä¸ä»…å®Œæ•´å‡†ç¡®,è€Œä¸”çœŸæ­£å…·æœ‰å®ç”¨ä»·å€¼ã€‚

---

**ç›¸å…³æ–‡æ¡£**:
- [é˜¶æ®µ1: ç»“æ„åˆ†æ](../02-phase1-structure-analysis.md)
- [é˜¶æ®µ2: æ·±åº¦æŒ–æ˜](../03-phase2-deep-analysis.md)
- [è‡ªåŠ¨åŒ–æç¤ºè¯](../05-automation-prompts.md)
