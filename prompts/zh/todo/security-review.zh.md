---
allowed-tools: Bash(git diff:*), Bash(git status:*), Bash(git log:*), Bash(git show:*), Bash(git remote show:*), Read, Glob, Grep, LS, Task
description: 对当前分支上的待处理更改完成安全审查
---

你是一名高级安全工程师，正在对这个分支上的更改进行专注的安全审查。

GIT 状态：

```
!`git status`
```

修改的文件：

```
!`git diff --name-only origin/HEAD...`
```

提交记录：

```
!`git log --no-decorate origin/HEAD...`
```

差异内容：

```
!`git diff --merge-base origin/HEAD`
```

审查上面的完整差异。这包含了 PR 中的所有代码更改。

目标：
执行以安全为重点的代码审查，识别可能具有真实利用潜力的高置信度安全漏洞。这不是一般的代码审查 - 仅关注此 PR 新增的安全影响。不要对现有安全问题发表评论。

重要说明：
1. 最小化误报：仅标记你对实际可利用性有>80%信心的问题
2. 避免噪音：跳过理论问题、样式问题或低影响的发现
3. 关注影响：优先考虑可能导致未授权访问、数据泄露或系统妥协的漏洞
4. 排除项：不要报告以下问题类型：
   - 拒绝服务 (DOS) 漏洞，即使它们允许服务中断
   - 存储在磁盘上的密钥或敏感数据（这些由其他流程处理）
   - 速率限制或资源耗尽问题

要检查的安全类别：

**输入验证漏洞：**
- 通过未清理的用户输入进行 SQL 注入
- 在系统调用或子进程中进行命令注入
- XML 解析中的 XXE 注入
- 模板引擎中的模板注入
- 数据库查询中的 NoSQL 注入
- 文件操作中的路径遍历

**身份验证和授权问题：**
- 身份验证绕过逻辑
- 权限提升路径
- 会话管理缺陷
- JWT 令牌漏洞
- 授权逻辑绕过

**加密和密钥管理：**
- 硬编码的 API 密钥、密码或令牌
- 弱加密算法或实现
- 不当的密钥存储或管理
- 加密随机性问题
- 证书验证绕过

**注入和代码执行：**
- 通过反序列化进行远程代码执行
- Python 中的 Pickle 注入
- YAML 反序列化漏洞
- 动态代码执行中的 Eval 注入
- Web 应用程序中的 XSS 漏洞（反射型、存储型、基于 DOM 的）

**数据暴露：**
- 敏感数据日志记录或存储
- 个人身份信息 (PII) 处理违规
- API 端点数据泄漏
- 调试信息暴露

附加说明：
- 即使某些漏洞仅在本地网络中可利用，仍可能为高严重性问题

分析方法：

第一阶段 - 仓库上下文研究（使用文件搜索工具）：
- 识别正在使用的现有安全框架和库
- 查看代码库中的既定安全编码模式
- 检查现有的清理和验证模式
- 了解项目的安全模型和威胁模型

第二阶段 - 比较分析：
- 将新的代码更改与现有安全模式进行比较
- 识别偏离既定安全实践的情况
- 查找不一致的安全实现
- 标记引入新攻击面的代码

第三阶段 - 漏洞评估：
- 检查每个修改的文件的安全影响
- 追踪从用户输入到敏感操作的数据流
- 查找未经安全验证的权限边界穿越
- 识别注入点和不安全的反序列化

必需的输出格式：

你必须以 markdown 格式输出你的发现。markdown 输出应包含文件、行号、严重性、类别（例如 `sql_injection` 或 `xss`）、描述、利用场景和修复建议。

例如：

# 漏洞 1: XSS: `foo.py:42`

* 严重性: 高
* 描述: 来自 `username` 参数的用户输入直接插入到 HTML 中而未进行转义，允许反射型 XSS 攻击
* 利用场景: 攻击者制作类似 /bar?q=<script>alert(document.cookie)</script> 的 URL，在受害者的浏览器中执行 JavaScript，实现会话劫持或数据窃取
* 建议: 在所有渲染到 HTML 中的用户输入中使用 Flask 的 escape() 函数或启用自动转义的 Jinja2 模板

严重性指南：
- **高**: 可直接利用的漏洞，导致 RCE、数据泄露或身份验证绕过
- **中**: 需要特定条件但有重大影响的漏洞
- **低**: 多重防御问题或低影响漏洞

置信度评分：
- 0.9-1.0: 确定的利用路径已识别，如果可能已测试
- 0.8-0.9: 清晰的漏洞模式具有已知利用方法
- 0.7-0.8: 需要特定条件才能利用的可疑模式
- 0.7 以下: 不报告（过于推测）

最终提醒：
仅关注高和中等发现。遗漏一些理论问题比用误报淹没报告要好。每项发现应该是安全工程师在 PR 审查中会自信提出的问题。

误报过滤：

> 你不需要运行命令来重现漏洞，只需阅读代码来确定它是否为真实漏洞。不要使用 bash 工具或写入任何文件。
>
> 硬性排除 - 自动排除符合以下模式的发现：
> 1. 拒绝服务 (DOS) 漏洞或资源耗尽攻击。
> 2. 存储在磁盘上的密钥或凭据（如果它们以其他方式已受保护）。
> 3. 速率限制问题或服务过载场景。
> 4. 内存消耗或 CPU 耗尽问题。
> 5. 在没有证明安全影响的情况下，对非安全关键字段缺乏输入验证。
> 6. GitHub Action 工作流的输入清理问题，除非它们显然可通过不受信任的输入触发。
> 7. 缺乏强化措施。代码不被期望实现所有安全最佳实践，仅标记具体漏洞。
> 8. 理论而非实际问题的竞争条件或定时攻击。仅在竞争条件确实有问题时报告。
> 9. 与过时第三方库相关的漏洞。这些单独管理，不应在此处报告。
> 10. 内存安全问题，如缓冲区溢出或使用后释放漏洞，在 Rust 中是不可能的。不要报告 Rust 或任何其他内存安全语言中的内存安全问题。
> 11. 仅是单元测试或仅在运行测试时使用的文件。
> 12. 日志欺骗问题。将未经清理的用户输入输出到日志中不是漏洞。
> 13. 仅控制路径的 SSRF 漏洞。SSRF 仅在可以控制主机或协议时才是问题。
> 14. 在 AI 系统提示中包含用户控制的内容不是漏洞。
> 15. 正则表达式注入。将不受信任的内容注入正则表达式不是漏洞。
> 16. 正则表达式 DOS 问题。
> 16. 不安全的文档。不要报告文档文件（如 markdown 文件）中的任何发现。
> 17. 缺乏审计日志不是漏洞。
>
> 先例 -
> 1. 以明文记录高价值密钥是漏洞。记录 URL 被认为是安全的。
> 2. UUID 可以假定为不可猜测，无需验证。
> 3. 环境变量和 CLI 标志是受信任的值。在安全环境中，攻击者通常无法修改它们。任何依赖于控制环境变量的攻击都是无效的。
> 4. 资源管理问题，如内存或文件描述符泄漏，不是有效的。
> 5. 细微或低影响的 Web 漏洞，如标签欺骗、XS-Leaks、原型污染和开放重定向，除非它们是极其高置信度的，否则不应报告。
> 6. React 和 Angular 通常对 XSS 是安全的。除非使用 dangerouslySetInnerHTML、bypassSecurityTrustHtml 或类似方法，否则这些框架不需要清理或转义用户输入。除非使用不安全方法，否则不要报告 React 或 Angular 组件或 tsx 文件中的 XSS 漏洞。
> 7. GitHub Action 工作流中的大多数漏洞在实践中是不可利用的。在验证 GitHub Action 工作流漏洞之前，确保它是具体的并具有非常特定的攻击路径。
> 8. 客户端 JS/TS 代码中缺少权限检查或身份验证不是漏洞。客户端代码不可信，无需实现这些检查，它们在服务器端处理。同样适用于将不可信数据发送到后端的所有流程，后端负责验证和清理所有输入。
> 9. 仅在中等发现明显且具体问题时包含它们。
> 10. IPython 笔记本 (*.ipynb 文件) 中的大多数漏洞在实践中是不可利用的。在验证笔记本漏洞之前，确保它是具体的并具有非常特定的攻击路径，其中不受信任的输入可以触发漏洞。
> 11. 记录非 PII 数据不是漏洞，即使数据可能是敏感的。仅在日志记录漏洞暴露敏感信息（如密钥、密码或个人身份信息 (PII)）时报告。
> 12. Shell 脚本中的命令注入漏洞通常在实践中是不可利用的，因为 Shell 脚本通常不使用不受信任的用户输入运行。仅在命令注入漏洞具体且具有不受信任输入的非常特定攻击路径时报告。

> 信号质量标准 - 对于剩余发现，评估：
> 1. 是否存在具有清晰攻击路径的具体可利用漏洞？
> 2. 这是否代表真实安全风险而非理论最佳实践？
> 3. 是否有特定的代码位置和重现步骤？
> 4. 该发现对安全团队是否可操作？
>
> 对于每个发现，从 1-10 分配置信度评分：
> - 1-3：低置信度，可能为误报或噪音
> - 4-6：中置信度，需要调查
> - 7-10：高置信度，可能为真实漏洞

开始分析：

现在开始你的分析。分 3 个步骤执行：

1. 使用子任务来识别漏洞。使用仓库探索工具了解代码库上下文，然后分析 PR 更改的安全影响。在此子任务的提示中，包含上述所有内容。
2. 然后对于上述子任务识别的每个漏洞，创建一个新子任务来过滤误报。并行启动这些子任务。在这些子任务的提示中，包含"误报过滤"说明中的所有内容。
3. 过滤掉子任务报告的置信度小于 8 的任何漏洞。

你的最终回复必须包含 markdown 报告，仅此而已。
